name: QA Testing Framework CI/CD

on:
  push:
    branches: [ main, develop, "claude/**" ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Run linting
      run: |
        pip install flake8 black
        flake8 protocols validators test_data monitoring --max-line-length=100 --ignore=E203,W503
        black --check protocols validators test_data monitoring

    - name: Run type checking
      run: |
        pip install mypy
        mypy protocols validators test_data monitoring --ignore-missing-imports || true

    - name: Run unit tests
      run: |
        pytest tests/unit -v --tb=short --cov=protocols --cov=validators --cov=test_data --cov=monitoring --cov-report=xml --cov-report=html

    - name: Run integration tests
      run: |
        pytest tests/integration -v --tb=short

    - name: Run e2e tests
      run: |
        pytest tests/e2e -v --tb=short

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Generate coverage report
      run: |
        coverage report
        coverage html

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: htmlcov/

  validation:
    name: Schema and Data Validation
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Validate JSON schemas
      run: |
        python -c "
        import json
        from pathlib import Path
        import jsonschema

        schemas_dir = Path('protocols/schemas')
        for schema_file in schemas_dir.glob('*.json'):
            try:
                with open(schema_file) as f:
                    schema = json.load(f)
                    # Validate schema itself
                    jsonschema.Draft7Validator.check_schema(schema)
                    print(f'✓ {schema_file.name} is valid')
            except Exception as e:
                print(f'✗ {schema_file.name}: {e}')
                raise
        "

    - name: Validate protocol templates
      run: |
        python -c "
        import json
        from pathlib import Path
        from validators import SchemaValidator

        validator = SchemaValidator()
        templates_dir = Path('protocols/templates')
        errors = []

        for template_file in templates_dir.glob('*.json'):
            try:
                with open(template_file) as f:
                    template = json.load(f)
                result = validator.validate_protocol(template)
                if result['is_valid']:
                    print(f'✓ {template_file.name} is valid')
                else:
                    print(f'✗ {template_file.name}: {result[\"errors\"]}')
                    errors.append(template_file.name)
            except Exception as e:
                print(f'✗ {template_file.name}: {e}')
                errors.append(template_file.name)

        if errors:
            raise Exception(f'Validation failed for: {errors}')
        "

  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint flake8 black mypy

    - name: Run Pylint
      run: |
        pylint protocols validators test_data monitoring --rcfile=.pylintrc || true

    - name: Run Flake8
      run: |
        flake8 protocols validators test_data monitoring --max-line-length=100 --statistics

    - name: Check code formatting
      run: |
        black --check protocols validators test_data monitoring

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Run performance tests
      run: |
        pytest tests/e2e -m slow -v --tb=short || true

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run Bandit security scan
      run: |
        pip install bandit
        bandit -r protocols validators test_data monitoring -ll || true

    - name: Check for known vulnerabilities
      run: |
        pip install safety
        pip freeze | safety check || true

  build-status:
    name: Build Status Report
    runs-on: ubuntu-latest
    needs: [test, validation, quality-checks]
    if: always()

    steps:
    - name: Report build status
      run: |
        echo "Test job: ${{ needs.test.result }}"
        echo "Validation job: ${{ needs.validation.result }}"
        echo "Quality checks job: ${{ needs.quality-checks.result }}"
