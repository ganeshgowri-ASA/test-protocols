{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PV Testing Protocol Schema",
  "description": "Comprehensive schema for photovoltaic testing protocols",
  "type": "object",
  "required": ["protocol_metadata", "general_data"],
  "properties": {
    "protocol_metadata": {
      "type": "object",
      "description": "Core protocol identification and configuration",
      "required": ["protocol_id", "protocol_name", "version"],
      "properties": {
        "protocol_id": {
          "type": "string",
          "description": "Unique identifier for the protocol"
        },
        "protocol_name": {
          "type": "string",
          "description": "Human-readable protocol name"
        },
        "version": {
          "type": "string",
          "description": "Protocol version (semantic versioning)"
        },
        "category": {
          "type": "string",
          "description": "Protocol category (e.g., electrical, mechanical, environmental)",
          "enum": ["electrical", "mechanical", "environmental", "optical", "thermal", "reliability", "quality_control"]
        },
        "standard_reference": {
          "type": "string",
          "description": "Reference to testing standard (e.g., IEC 61215, IEC 61730)"
        },
        "description": {
          "type": "string",
          "description": "Detailed protocol description"
        },
        "tags": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Keywords for searchability"
        }
      }
    },
    "general_data": {
      "type": "object",
      "description": "General test information and metadata",
      "properties": {
        "fields": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/field"
          }
        }
      }
    },
    "sample_info": {
      "type": "object",
      "description": "Sample identification and specifications",
      "properties": {
        "fields": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/field"
          }
        }
      }
    },
    "protocol_inputs": {
      "type": "object",
      "description": "Test parameters and input configurations",
      "properties": {
        "sections": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "section_id": {"type": "string"},
              "section_title": {"type": "string"},
              "fields": {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/field"
                }
              }
            }
          }
        }
      }
    },
    "live_readings": {
      "type": "object",
      "description": "Real-time data capture during testing",
      "properties": {
        "tables": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "table_id": {"type": "string"},
              "table_name": {"type": "string"},
              "columns": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "column_id": {"type": "string"},
                    "column_name": {"type": "string"},
                    "data_type": {
                      "type": "string",
                      "enum": ["number", "text", "datetime", "boolean"]
                    },
                    "unit": {"type": "string"},
                    "required": {"type": "boolean"}
                  }
                }
              },
              "editable": {"type": "boolean", "default": true},
              "min_rows": {"type": "integer", "default": 1}
            }
          }
        }
      }
    },
    "analysis": {
      "type": "object",
      "description": "Data analysis and calculations",
      "properties": {
        "calculations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "calc_id": {"type": "string"},
              "calc_name": {"type": "string"},
              "formula": {"type": "string"},
              "description": {"type": "string"},
              "output_unit": {"type": "string"},
              "dependencies": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          }
        },
        "statistical_analysis": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "analysis_type": {
                "type": "string",
                "enum": ["mean", "median", "std_dev", "min", "max", "percentile", "regression"]
              },
              "target_field": {"type": "string"},
              "output_name": {"type": "string"}
            }
          }
        }
      }
    },
    "charts": {
      "type": "object",
      "description": "Data visualization configurations",
      "properties": {
        "visualizations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "chart_id": {"type": "string"},
              "chart_type": {
                "type": "string",
                "enum": ["line", "scatter", "bar", "histogram", "heatmap", "box", "contour"]
              },
              "title": {"type": "string"},
              "x_axis": {
                "type": "object",
                "properties": {
                  "field": {"type": "string"},
                  "label": {"type": "string"},
                  "unit": {"type": "string"}
                }
              },
              "y_axis": {
                "type": "object",
                "properties": {
                  "field": {"type": "string"},
                  "label": {"type": "string"},
                  "unit": {"type": "string"}
                }
              },
              "series": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "name": {"type": "string"},
                    "data_source": {"type": "string"}
                  }
                }
              }
            }
          }
        }
      }
    },
    "quality_control": {
      "type": "object",
      "description": "QC validation rules and acceptance criteria",
      "properties": {
        "validation_rules": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "rule_id": {"type": "string"},
              "rule_name": {"type": "string"},
              "field": {"type": "string"},
              "rule_type": {
                "type": "string",
                "enum": ["range", "threshold", "comparison", "pattern", "custom"]
              },
              "parameters": {
                "type": "object",
                "properties": {
                  "min": {"type": "number"},
                  "max": {"type": "number"},
                  "threshold": {"type": "number"},
                  "operator": {"type": "string"},
                  "pattern": {"type": "string"}
                }
              },
              "severity": {
                "type": "string",
                "enum": ["critical", "warning", "info"]
              },
              "message": {"type": "string"}
            }
          }
        },
        "acceptance_criteria": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "criteria_id": {"type": "string"},
              "description": {"type": "string"},
              "pass_condition": {"type": "string"},
              "reference_standard": {"type": "string"}
            }
          }
        }
      }
    },
    "maintenance": {
      "type": "object",
      "description": "Equipment maintenance tracking",
      "properties": {
        "fields": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/field"
          }
        },
        "maintenance_schedule": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "task": {"type": "string"},
              "frequency": {"type": "string"},
              "last_performed": {"type": "string", "format": "date"},
              "next_due": {"type": "string", "format": "date"}
            }
          }
        }
      }
    },
    "project_management": {
      "type": "object",
      "description": "Project tracking and resource management",
      "properties": {
        "fields": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/field"
          }
        },
        "milestones": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "milestone_name": {"type": "string"},
              "target_date": {"type": "string", "format": "date"},
              "status": {
                "type": "string",
                "enum": ["not_started", "in_progress", "completed", "delayed"]
              }
            }
          }
        }
      }
    },
    "nc_register": {
      "type": "object",
      "description": "Non-conformance register for tracking issues",
      "properties": {
        "fields": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/field"
          }
        },
        "nc_tracking": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "nc_id": {"type": "string"},
              "description": {"type": "string"},
              "severity": {
                "type": "string",
                "enum": ["minor", "major", "critical"]
              },
              "date_identified": {"type": "string", "format": "date"},
              "status": {
                "type": "string",
                "enum": ["open", "investigating", "resolved", "closed"]
              },
              "corrective_action": {"type": "string"},
              "responsible_person": {"type": "string"}
            }
          }
        }
      }
    },
    "report_template": {
      "type": "object",
      "description": "Report generation configuration",
      "properties": {
        "sections": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "section_name": {"type": "string"},
              "include_in_report": {"type": "boolean"},
              "content_source": {"type": "string"}
            }
          }
        },
        "export_formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["pdf", "excel", "csv", "json"]
          }
        }
      }
    }
  },
  "definitions": {
    "field": {
      "type": "object",
      "required": ["field_id", "field_name", "field_type"],
      "properties": {
        "field_id": {
          "type": "string",
          "description": "Unique identifier for the field"
        },
        "field_name": {
          "type": "string",
          "description": "Display name for the field"
        },
        "field_type": {
          "type": "string",
          "enum": ["text", "number", "date", "datetime", "select", "multiselect", "textarea", "checkbox", "file_upload", "calculated"],
          "description": "Type of input field"
        },
        "description": {
          "type": "string",
          "description": "Help text for the field"
        },
        "required": {
          "type": "boolean",
          "default": false,
          "description": "Whether field is required"
        },
        "default_value": {
          "description": "Default value for the field"
        },
        "unit": {
          "type": "string",
          "description": "Unit of measurement"
        },
        "validation": {
          "type": "object",
          "properties": {
            "min": {"type": "number"},
            "max": {"type": "number"},
            "pattern": {"type": "string"},
            "options": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "calculation": {
          "type": "object",
          "description": "For calculated fields",
          "properties": {
            "formula": {"type": "string"},
            "dependencies": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "conditional_display": {
          "type": "object",
          "description": "Show field based on condition",
          "properties": {
            "depends_on": {"type": "string"},
            "condition": {"type": "string"},
            "value": {}
          }
        }
      }
    }
  }
}
